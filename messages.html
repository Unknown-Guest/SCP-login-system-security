<!DOCTYPE html>
<html>
<head>
<style>
    :root { --scp-green: #3fbf3f; --scp-green-soft: #6fdc6f; --scp-red: #ff3f3f; --scp-gray-text: #666; }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background-color: #000; font-family: Arial, sans-serif; color: var(--scp-green); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

    #header { width: 100%; border-bottom: 2px solid var(--scp-green); box-shadow: 0 0 12px var(--scp-green), inset 0 0 6px #001a00; padding: 18px 40px; text-align: center; background: #000; flex-shrink: 0; }
    #header-title { font-size: 28px; font-weight: bold; letter-spacing: 8px; text-shadow: 0 0 10px var(--scp-green), 0 0 2px var(--scp-green); }
    #header-sub { font-size: 10px; letter-spacing: 2px; color: var(--scp-green-soft); text-shadow: 0 0 4px var(--scp-green-soft); margin-top: 5px; }

    #navbar { width: 100%; display: flex; border-bottom: 1px solid var(--scp-green); background: #050505; flex-shrink: 0; }
    .nav-btn { padding: 12px 32px; background: transparent; border: none; border-right: 1px solid var(--scp-green); color: var(--scp-green); font-size: 12px; font-weight: bold; letter-spacing: 2.5px; cursor: pointer; transition: 0.15s; opacity: 0.6; }
    .nav-btn:hover { opacity: 1; background: #0a1a0a; }
    .nav-btn.active { opacity: 1; background: var(--scp-green); color: #000; box-shadow: 0 0 10px var(--scp-green); }
    #nav-logout { margin-left: 0; padding: 12px 24px; background: transparent; border: none; border-left: 1px solid var(--scp-green); color: var(--scp-green); font-size: 11px; letter-spacing: 2px; cursor: pointer; opacity: 0.5; transition: 0.15s; }
    #nav-logout:hover { opacity: 1; color: var(--scp-red); }
    #nav-refresh { padding: 12px 18px; background: transparent; border: none; border-left: 1px solid var(--scp-green); color: var(--scp-green); font-size: 13px; cursor: pointer; opacity: 0.5; transition: 0.15s; margin-left: auto; }
    #nav-refresh:hover { opacity: 1; }

    #main { display: flex; flex: 1; overflow: hidden; }

    #sidebar { width: 200px; border-right: 1px solid var(--scp-green); display: flex; flex-direction: column; background: #020202; flex-shrink: 0; }
    #new-chat-btn { margin: 12px 12px 5px; padding: 10px; background: var(--scp-green); color: #000; border: none; font-size: 11px; font-weight: bold; letter-spacing: 2px; cursor: pointer; box-shadow: 0 0 6px var(--scp-green); transition: 0.15s; }
    #new-chat-btn:hover { background: #5fff5f; }
    #new-group-btn { margin: 0 12px 12px; padding: 8px; background: transparent; border: 1px solid var(--scp-green); color: var(--scp-green); font-size: 11px; letter-spacing: 1.5px; cursor: pointer; transition: 0.15s; }
    #new-group-btn:hover { background: #0a1a0a; }
    .sidebar-tab { padding: 13px 16px; background: transparent; border: none; border-bottom: 1px solid #1a1a1a; color: var(--scp-green); font-size: 11px; letter-spacing: 1.5px; cursor: pointer; text-align: left; transition: 0.15s; opacity: 0.55; }
    .sidebar-tab:hover { background: #0a1a0a; opacity: 1; }
    .sidebar-tab.active { opacity: 1; background: #0a1a0a; border-left: 3px solid var(--scp-green); }

    #conv-panel { width: 230px; border-right: 1px solid var(--scp-green); display: flex; flex-direction: column; background: #010101; flex-shrink: 0; }
    #conv-panel-label { padding: 10px 14px; font-size: 10px; letter-spacing: 2px; color: var(--scp-gray-text); border-bottom: 1px solid #111; flex-shrink: 0; }
    #conv-list { flex: 1; overflow-y: auto; }
    .conv-item { padding: 13px 14px; border-bottom: 1px solid #0d0d0d; cursor: pointer; transition: 0.1s; position: relative; }
    .conv-item:hover { background: #0a1a0a; }
    .conv-item.active { background: #0d1f0d; border-left: 3px solid var(--scp-green); }
    .conv-item.unread .conv-name { color: #fff; font-weight: bold; }
    .conv-name { font-size: 12px; letter-spacing: 1px; color: var(--scp-green); margin-bottom: 3px; }
    .conv-preview { font-size: 11px; color: var(--scp-gray-text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 170px; }
    .conv-time { position: absolute; top: 13px; right: 10px; font-size: 10px; color: var(--scp-gray-text); }
    .unread-dot { display: inline-block; width: 6px; height: 6px; background: var(--scp-green); border-radius: 50%; margin-right: 5px; box-shadow: 0 0 4px var(--scp-green); vertical-align: middle; }
    .empty-msg { padding: 20px; font-size: 11px; letter-spacing: 1px; color: var(--scp-gray-text); text-align: center; line-height: 1.8; }

    #chat-panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    #chat-placeholder { flex: 1; display: flex; justify-content: center; align-items: center; font-size: 11px; letter-spacing: 2px; color: var(--scp-gray-text); }

    #chat-header { padding: 12px 16px; border-bottom: 1px solid var(--scp-green); background: #020202; flex-shrink: 0; display: flex; align-items: center; gap: 10px; }
    #chat-header-info { flex: 1; }
    #chat-header-name { font-size: 13px; letter-spacing: 2px; text-shadow: 0 0 4px var(--scp-green); }
    #chat-header-members { font-size: 10px; color: var(--scp-gray-text); letter-spacing: 1px; margin-top: 2px; }

    .hdr-btn { padding: 5px 11px; font-size: 11px; letter-spacing: 1px; cursor: pointer; border: 1px solid; transition: 0.15s; background: transparent; border-radius: 2px; }
    .hdr-red { color: var(--scp-red); border-color: var(--scp-red); }
    .hdr-red:hover { background: var(--scp-red); color: #000; }
    .hdr-green { color: var(--scp-green); border-color: var(--scp-green); }
    .hdr-green:hover { background: var(--scp-green); color: #000; }

    #chat-messages { flex: 1; overflow-y: auto; padding: 16px 20px; display: flex; flex-direction: column; gap: 14px; }

    .bubble-row { display: flex; position: relative; }
    .bubble-row.me { justify-content: flex-end; }
    .bubble-row.them { justify-content: flex-start; }
    .bubble-wrap { display: flex; flex-direction: column; max-width: 58%; position: relative; }
    .bubble-row.me .bubble-wrap { align-items: flex-end; }
    .bubble-row.them .bubble-wrap { align-items: flex-start; }
    .bubble-sender { font-size: 10px; color: var(--scp-green-soft); letter-spacing: 1px; margin-bottom: 3px; opacity: 0.8; }
    .bubble { padding: 9px 13px; font-size: 13px; line-height: 1.5; word-break: break-word; }
    .bubble.me { background: var(--scp-green); color: #000; box-shadow: 0 0 8px var(--scp-green); border-radius: 10px 10px 2px 10px; }
    .bubble.them { background: #0d1f0d; color: var(--scp-green-soft); border: 1px solid var(--scp-green); box-shadow: inset 0 0 4px #001a00; border-radius: 10px 10px 10px 2px; }
    .bubble-meta { font-size: 10px; color: var(--scp-gray-text); margin-top: 3px; display: flex; gap: 6px; align-items: center; }
    .edited-tag { font-size: 10px; color: var(--scp-gray-text); font-style: italic; }
    .reaction { font-size: 14px; margin-top: 3px; display: inline-block; }

    .bubble-actions {
        display: none;
        position: absolute;
        top: calc(100% + 4px);
        background: #050505;
        border: 1px solid var(--scp-green);
        box-shadow: 0 0 10px #001a00;
        padding: 4px 6px;
        gap: 4px;
        z-index: 20;
        border-radius: 4px;
        white-space: nowrap;
    }
    .bubble-actions.visible { display: flex; }
    .bubble-row.me .bubble-actions { right: 0; }
    .bubble-row.them .bubble-actions { left: 0; }

    .action-btn { width: 28px; height: 28px; background: transparent; border: 1px solid #222; color: var(--scp-green); font-size: 13px; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 4px; transition: 0.1s; padding: 0; }
    .action-btn:hover { background: #0a1a0a; border-color: var(--scp-green); }
    .action-btn.red:hover { background: #1a0000; border-color: var(--scp-red); }

    #chat-input-bar { display: flex; border-top: 1px solid var(--scp-green); background: #020202; flex-shrink: 0; }
    #chat-input { flex: 1; padding: 13px 16px; background: #050505; border: none; color: var(--scp-green); font-size: 13px; outline: none; font-family: Arial, sans-serif; }
    #chat-input::placeholder { color: #2a5a2a; }
    #chat-send-btn { padding: 13px 22px; background: var(--scp-green); color: #000; border: none; font-size: 12px; font-weight: bold; letter-spacing: 2px; cursor: pointer; box-shadow: 0 0 8px var(--scp-green); transition: 0.15s; }
    #chat-send-btn:hover { background: #5fff5f; }

    .member-tag { display: inline-block; padding: 2px 8px; border: 1px solid var(--scp-green); font-size: 10px; letter-spacing: 1px; margin: 2px; border-radius: 10px; }

    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.88); z-index: 100; justify-content: center; align-items: center; }
    .modal-box { border: 2px solid var(--scp-green); background: #000; box-shadow: 0 0 20px var(--scp-green); padding: 26px 30px; width: 320px; display: flex; flex-direction: column; gap: 13px; max-height: 80vh; overflow-y: auto; }
    .modal-box.danger { border-color: var(--scp-red); box-shadow: 0 0 20px var(--scp-red); }
    .modal-title { font-size: 13px; letter-spacing: 3px; text-shadow: 0 0 4px var(--scp-green); }
    .modal-title.red { color: var(--scp-red); text-shadow: 0 0 4px var(--scp-red); }
    .modal-lbl { font-size: 11px; letter-spacing: 1.5px; margin-bottom: 5px; display: block; }
    .modal-input { width: 100%; padding: 10px 12px; background: #050505; border: 1px solid var(--scp-green); color: var(--scp-green); font-size: 13px; outline: none; font-family: Arial, sans-serif; }
    .modal-input::placeholder { color: #2a5a2a; }
    .modal-error { color: var(--scp-red); font-size: 11px; min-height: 14px; }
    .modal-info { color: var(--scp-green-soft); font-size: 11px; letter-spacing: 1px; line-height: 1.6; }
    .modal-btn-primary { padding: 10px; background: var(--scp-green); color: #000; border: none; font-size: 12px; font-weight: bold; letter-spacing: 2px; cursor: pointer; box-shadow: 0 0 8px var(--scp-green); }
    .modal-btn-primary:hover { background: #5fff5f; }
    .modal-btn-danger { padding: 10px; background: var(--scp-red); color: #000; border: none; font-size: 12px; font-weight: bold; letter-spacing: 2px; cursor: pointer; }
    .modal-btn-danger:hover { background: #ff6666; }
    .modal-btn-secondary { padding: 9px; background: transparent; border: 1px solid var(--scp-green); color: var(--scp-green); font-size: 11px; letter-spacing: 2px; cursor: pointer; opacity: 0.6; }
    .modal-btn-secondary:hover { opacity: 1; }

    #group-members-list { display: flex; flex-wrap: wrap; gap: 6px; min-height: 30px; }
    .member-chip { display: flex; align-items: center; gap: 4px; padding: 3px 8px; border: 1px solid var(--scp-green); font-size: 11px; letter-spacing: 1px; border-radius: 10px; }
    .member-chip button { background: none; border: none; color: var(--scp-red); cursor: pointer; font-size: 12px; padding: 0; line-height: 1; }
    .add-member-row { display: flex; gap: 6px; }
    .add-member-row input { flex: 1; padding: 8px 10px; background: #050505; border: 1px solid var(--scp-green); color: var(--scp-green); font-size: 12px; outline: none; font-family: Arial, sans-serif; }
    .add-member-row button { padding: 8px 12px; background: var(--scp-green); color: #000; border: none; font-size: 16px; cursor: pointer; font-weight: bold; }
    .add-member-row button:hover { background: #5fff5f; }
</style>
</head>
<body>

<div id="header">
    <div id="header-title">SCP WEBSITE</div>
    <div id="header-sub">// PROTECTED WEBSITE //</div>
</div>

<div id="navbar">
    <button class="nav-btn" onclick="window.location.href='home.html'">HOME</button>
    <button class="nav-btn" onclick="window.location.href='files.html'">FILES</button>
    <button class="nav-btn" onclick="window.location.href='hacking.html'">HACKS</button>
    <button class="nav-btn" onclick="window.location.href='console.html'">CONSOLE</button>
    <button class="nav-btn active">MESSAGES</button>
    <button id="nav-refresh" onclick="location.reload()" title="Refresh">‚ü≥</button>
    <button id="nav-logout" onclick="window.location.href='Index.html'">[ LOGOUT ]</button>
</div>

<div id="main">
    <div id="sidebar">
        <button id="new-chat-btn" onclick="openNewChatModal()">+ NEW CHAT</button>
        <button id="new-group-btn" onclick="openNewGroupModal()">+ NEW GROUP</button>
        <button class="sidebar-tab active" id="tab-chats" onclick="switchTab('chats')">üí¨ CHATS</button>
        <button class="sidebar-tab" id="tab-group" onclick="switchTab('group')">üë• GROUP CHATS</button>
        <button class="sidebar-tab" id="tab-deleted" onclick="switchTab('deleted')">üóë DELETED CHATS</button>
    </div>

    <div id="conv-panel">
        <div id="conv-panel-label">CHATS</div>
        <div id="conv-list"></div>
    </div>

    <div id="chat-panel">
        <div id="chat-placeholder">// SELECT A CONVERSATION //</div>
    </div>
</div>

<!-- NEW CHAT MODAL -->
<div class="modal-overlay" id="new-chat-modal">
    <div class="modal-box">
        <div class="modal-title">NEW CHAT</div>
        <div>
            <label class="modal-lbl">TO (USERNAME)</label>
            <input id="new-chat-user" class="modal-input" placeholder="RECIPIENT_USERNAME" maxlength="20" autocomplete="off" onkeydown="if(event.key==='Enter') startNewChat()"/>
        </div>
        <div class="modal-error" id="new-chat-error"></div>
        <button class="modal-btn-primary" onclick="startNewChat()">‚ñ∂ START CHAT</button>
        <button class="modal-btn-secondary" onclick="closeModal('new-chat-modal')">‚úï CANCEL</button>
    </div>
</div>

<!-- NEW GROUP MODAL -->
<div class="modal-overlay" id="new-group-modal">
    <div class="modal-box">
        <div class="modal-title">NEW GROUP CHAT</div>
        <div>
            <label class="modal-lbl">GROUP NAME</label>
            <input id="group-name-input" class="modal-input" placeholder="GROUP NAME" maxlength="30" autocomplete="off"/>
        </div>
        <div>
            <label class="modal-lbl">ADD MEMBERS</label>
            <div class="add-member-row">
                <input id="group-member-input" class="modal-input" placeholder="USERNAME" maxlength="20" autocomplete="off" onkeydown="if(event.key==='Enter') addMemberToGroup()"/>
                <button onclick="addMemberToGroup()">+</button>
            </div>
        </div>
        <div id="group-members-list"></div>
        <div class="modal-error" id="new-group-error"></div>
        <button class="modal-btn-primary" onclick="createGroup()">‚ñ∂ CREATE GROUP</button>
        <button class="modal-btn-secondary" onclick="closeModal('new-group-modal')">‚úï CANCEL</button>
    </div>
</div>

<!-- ADD MEMBER TO EXISTING GROUP MODAL -->
<div class="modal-overlay" id="add-member-modal">
    <div class="modal-box">
        <div class="modal-title">ADD MEMBER</div>
        <div>
            <label class="modal-lbl">USERNAME</label>
            <input id="add-member-input" class="modal-input" placeholder="USERNAME" maxlength="20" autocomplete="off" onkeydown="if(event.key==='Enter') addMemberToExistingGroup()"/>
        </div>
        <div class="modal-error" id="add-member-error"></div>
        <button class="modal-btn-primary" onclick="addMemberToExistingGroup()">+ ADD</button>
        <button class="modal-btn-secondary" onclick="closeModal('add-member-modal')">‚úï CANCEL</button>
    </div>
</div>

<!-- EDIT MODAL -->
<div class="modal-overlay" id="edit-modal">
    <div class="modal-box">
        <div class="modal-title">EDIT MESSAGE</div>
        <div>
            <label class="modal-lbl">MESSAGE</label>
            <input id="edit-input" class="modal-input" maxlength="1000" autocomplete="off" onkeydown="if(event.key==='Enter') saveEdit()"/>
        </div>
        <button class="modal-btn-primary" onclick="saveEdit()">‚ñ∂ SAVE</button>
        <button class="modal-btn-secondary" onclick="closeModal('edit-modal')">‚úï CANCEL</button>
    </div>
</div>

<!-- CONFIRM DELETE CHAT -->
<div class="modal-overlay" id="confirm-modal">
    <div class="modal-box danger">
        <div class="modal-title red">‚ö† DELETE CHAT</div>
        <p class="modal-info">Are you sure? Messages will be moved to Deleted Chats.</p>
        <button class="modal-btn-danger" onclick="confirmDeleteChat()">‚úï YES, DELETE</button>
        <button class="modal-btn-secondary" onclick="closeModal('confirm-modal')">‚óÄ CANCEL</button>
    </div>
</div>

<!-- CONFIRM LEAVE GROUP -->
<div class="modal-overlay" id="leave-group-modal">
    <div class="modal-box danger">
        <div class="modal-title red">‚ö† LEAVE GROUP</div>
        <p class="modal-info">Are you sure you want to leave this group? You will no longer see its messages.</p>
        <button class="modal-btn-danger" onclick="confirmLeaveGroup()">‚úï YES, LEAVE</button>
        <button class="modal-btn-secondary" onclick="closeModal('leave-group-modal')">‚óÄ CANCEL</button>
    </div>
</div>

<!-- CONFIRM PERMA DELETE MESSAGE -->
<div class="modal-overlay" id="perma-msg-modal">
    <div class="modal-box danger">
        <div class="modal-title red">‚ö† PERMANENTLY DELETE</div>
        <p class="modal-info">This message will be permanently deleted and cannot be recovered.</p>
        <button class="modal-btn-danger" onclick="confirmPermaMsgDelete()">‚úï DELETE FOREVER</button>
        <button class="modal-btn-secondary" onclick="closeModal('perma-msg-modal')">‚óÄ CANCEL</button>
    </div>
</div>

<!-- CONFIRM PERMA DELETE WHOLE CONVERSATION -->
<div class="modal-overlay" id="perma-conv-modal">
    <div class="modal-box danger">
        <div class="modal-title red">‚ö† DELETE FOREVER</div>
        <p class="modal-info">This will permanently delete the entire conversation and cannot be undone.</p>
        <button class="modal-btn-danger" onclick="confirmPermaConvDelete()">‚úï DELETE FOREVER</button>
        <button class="modal-btn-secondary" onclick="closeModal('perma-conv-modal')">‚óÄ CANCEL</button>
    </div>
</div>

<script>
let currentUser = "";
let activeConv = null;
let activeTab = "chats";
let activeIsGroup = false;
let editingMsgId = null;
let permaMsgId = null;
let permaConvTarget = null; // { type: 'dm'|'group', id: string }
let pendingGroupMembers = [];

// -- STORAGE --
function getMessages() { return JSON.parse(localStorage.getItem("scpMessages")) || []; }
function saveMessages(m) { localStorage.setItem("scpMessages", JSON.stringify(m)); }
function getGroups() { return JSON.parse(localStorage.getItem("scpGroups")) || []; }
function saveGroups(g) { localStorage.setItem("scpGroups", JSON.stringify(g)); }

function formatTime(ts) {
    const d = new Date(ts), now = new Date();
    return d.toDateString() === now.toDateString()
        ? d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
        : d.toLocaleDateString([], { month: 'short', day: 'numeric' });
}

// -- TABS --
function switchTab(tab) {
    activeTab = tab;
    activeConv = null;
    activeIsGroup = false;
    ["chats","group","deleted"].forEach(t =>
        document.getElementById("tab-"+t).classList.toggle("active", t === tab)
    );
    const labels = { chats: "CHATS", group: "GROUP CHATS", deleted: "DELETED CHATS" };
    document.getElementById("conv-panel-label").innerText = labels[tab];
    renderConvList();
    document.getElementById("chat-panel").innerHTML = '<div id="chat-placeholder">// SELECT A CONVERSATION //</div>';
}

// -- CONV LIST --
function getConversations() {
    const msgs = getMessages();
    const people = {};
    msgs.forEach(m => {
        if (m.deletedMsg || m.groupId) return;
        const other = m.from.toLowerCase() === currentUser.toLowerCase() ? m.to
            : m.to && m.to.toLowerCase() === currentUser.toLowerCase() ? m.from : null;
        if (!other) return;
        const key = other.toLowerCase();
        if (!people[key] || m.timestamp > people[key].timestamp) {
            people[key] = { username: other, lastMsg: m.body, timestamp: m.timestamp, unread: false };
        }
        if (m.to && m.to.toLowerCase() === currentUser.toLowerCase() && !m.read) people[key].unread = true;
    });
    return Object.values(people).sort((a, b) => b.timestamp - a.timestamp);
}

function getGroupConversations() {
    // Only show groups that are NOT marked deleted
    const groups = getGroups().filter(g =>
        !g.deleted &&
        g.members.map(x=>x.toLowerCase()).includes(currentUser.toLowerCase())
    );
    const msgs = getMessages();
    return groups.map(g => {
        const gMsgs = msgs.filter(m => m.groupId === g.id && !m.deletedMsg);
        const last = gMsgs.sort((a,b) => b.timestamp - a.timestamp)[0];
        const unread = gMsgs.some(m => m.from.toLowerCase() !== currentUser.toLowerCase() && !m.read);
        return { ...g, lastMsg: last ? last.body : "No messages yet", timestamp: last ? last.timestamp : g.created, unread };
    }).sort((a,b) => b.timestamp - a.timestamp);
}

function getDeletedConvs() {
    const people = {};

    // Include groups marked as deleted
    getGroups().filter(g =>
        g.deleted &&
        g.members.map(x=>x.toLowerCase()).includes(currentUser.toLowerCase())
    ).forEach(g => {
        people["grp_" + g.id] = { username: g.name, isGroup: true, groupId: g.id };
    });

    // Include DMs with deleted messages, and any group messages marked deletedMsg (edge cases)
    getMessages().forEach(m => {
        if (!m.deletedMsg) return;
        if (m.groupId) {
            const g = getGroups().find(gr => gr.id === m.groupId);
            if (!g) return;
            const key = "grp_" + m.groupId;
            if (!people[key]) people[key] = { username: g.name, isGroup: true, groupId: m.groupId };
        } else {
            const other = m.from.toLowerCase() === currentUser.toLowerCase() ? m.to
                : m.to && m.to.toLowerCase() === currentUser.toLowerCase() ? m.from : null;
            if (!other) return;
            const key = other.toLowerCase();
            if (!people[key]) people[key] = { username: other, isGroup: false };
        }
    });

    return Object.values(people);
}

function renderConvList() {
    const list = document.getElementById("conv-list");
    list.innerHTML = "";

    if (activeTab === "deleted") {
        const convs = getDeletedConvs();
        if (convs.length === 0) { list.innerHTML = '<div class="empty-msg">// NO DELETED MESSAGES //</div>'; return; }
        convs.forEach(c => {
            const div = document.createElement("div");
            const isActive = c.isGroup ? activeConv === c.groupId : activeConv === c.username.toLowerCase();
            div.className = "conv-item" + (isActive ? " active" : "");
            div.onclick = () => c.isGroup ? openDeletedGroup(c.groupId, c.username) : openDeletedConv(c.username);
            div.innerHTML = `
                <div class="conv-name">${c.isGroup ? "üë• " : ""}${c.username}</div>
                <div class="conv-preview">Deleted messages</div>
            `;
            list.appendChild(div);
        });
        return;
    }

    if (activeTab === "group") {
        const groups = getGroupConversations();
        if (groups.length === 0) { list.innerHTML = '<div class="empty-msg">// NO GROUP CHATS //<br><br>Press + NEW GROUP</div>'; return; }
        groups.forEach(g => {
            const div = document.createElement("div");
            div.className = "conv-item" + (g.unread ? " unread" : "") + (activeConv === g.id ? " active" : "");
            div.onclick = () => openGroup(g.id);
            div.innerHTML = `
                <div class="conv-name">${g.unread ? '<span class="unread-dot"></span>' : ''}${g.name}</div>
                <div class="conv-preview">${g.lastMsg}</div>
                <div class="conv-time">${formatTime(g.timestamp)}</div>
            `;
            list.appendChild(div);
        });
        return;
    }

    const convs = getConversations();
    if (convs.length === 0) { list.innerHTML = '<div class="empty-msg">// NO CHATS YET //<br><br>Press + NEW CHAT</div>'; return; }
    convs.forEach(c => {
        const div = document.createElement("div");
        div.className = "conv-item" + (c.unread ? " unread" : "") + (activeConv === c.username.toLowerCase() ? " active" : "");
        div.onclick = () => openConversation(c.username);
        div.innerHTML = `
            <div class="conv-name">${c.unread ? '<span class="unread-dot"></span>' : ''}${c.username}</div>
            <div class="conv-preview">${c.lastMsg}</div>
            <div class="conv-time">${formatTime(c.timestamp)}</div>
        `;
        list.appendChild(div);
    });
}

// -- OPEN CONVERSATIONS --
function openConversation(username) {
    activeConv = username.toLowerCase();
    activeIsGroup = false;
    const msgs = getMessages();
    msgs.forEach(m => { if (m.from.toLowerCase() === username.toLowerCase() && m.to && m.to.toLowerCase() === currentUser.toLowerCase()) m.read = true; });
    saveMessages(msgs);
    renderConvList();
    renderChat();
}

function openGroup(groupId) {
    activeConv = groupId;
    activeIsGroup = true;
    const msgs = getMessages();
    msgs.forEach(m => { if (m.groupId === groupId && m.from.toLowerCase() !== currentUser.toLowerCase()) m.read = true; });
    saveMessages(msgs);
    renderConvList();
    renderChat();
}

function openDeletedGroup(groupId, groupName) {
    activeConv = groupId;
    activeIsGroup = true;
    renderConvList();
    const msgs = getMessages().filter(m => m.deletedMsg && m.groupId === groupId).sort((a,b) => a.timestamp - b.timestamp);
    const panel = document.getElementById("chat-panel");
    panel.innerHTML = `
        <div id="chat-header">
            <div id="chat-header-info">
                <div id="chat-header-name">${groupName.toUpperCase()}</div>
                <div id="chat-header-members">DELETED GROUP MESSAGES</div>
            </div>
            <button class="hdr-btn hdr-green" onclick="recoverAllGroupMsgs('${groupId}')">‚ôªÔ∏è RECOVER ALL</button>
            <button class="hdr-btn hdr-red" onclick="openPermaConvModal('group','${groupId}')">üóë DELETE FOREVER</button>
        </div>
        <div id="chat-messages"></div>
    `;
    const cm = document.getElementById("chat-messages");
    if (msgs.length === 0) { cm.innerHTML = '<div class="empty-msg">// NO DELETED MESSAGES //</div>'; return; }
    msgs.forEach(m => renderBubble(m, cm, true));
    cm.scrollTop = cm.scrollHeight;
}

function recoverAllGroupMsgs(groupId) {
    const msgs = getMessages();
    msgs.forEach(m => { if (m.deletedMsg && m.groupId === groupId) m.deletedMsg = false; });
    saveMessages(msgs);
    // Un-delete the group so it reappears in GROUP CHATS
    const groups = getGroups();
    const g = groups.find(gr => gr.id === groupId);
    if (g) { g.deleted = false; saveGroups(groups); }
    activeConv = null;
    renderConvList();
    document.getElementById("chat-panel").innerHTML = '<div id="chat-placeholder">// ALL MESSAGES RECOVERED //</div>';
}

function openDeletedConv(username) {
    activeConv = username.toLowerCase();
    activeIsGroup = false;
    renderConvList();
    const msgs = getMessages().filter(m =>
        m.deletedMsg &&
        ((m.from.toLowerCase() === currentUser.toLowerCase() && m.to && m.to.toLowerCase() === username.toLowerCase()) ||
         (m.to && m.to.toLowerCase() === currentUser.toLowerCase() && m.from.toLowerCase() === username.toLowerCase()))
    ).sort((a, b) => a.timestamp - b.timestamp);

    const panel = document.getElementById("chat-panel");
    panel.innerHTML = `
        <div id="chat-header">
            <div id="chat-header-info">
                <div id="chat-header-name">${username.toUpperCase()}</div>
                <div id="chat-header-members">DELETED MESSAGES</div>
            </div>
            <button class="hdr-btn hdr-green" onclick="recoverAllMsgs('${username}')">‚ôªÔ∏è RECOVER ALL</button>
            <button class="hdr-btn hdr-red" onclick="openPermaConvModal('dm','${username}')">üóë DELETE FOREVER</button>
        </div>
        <div id="chat-messages"></div>
    `;
    const cm = document.getElementById("chat-messages");
    if (msgs.length === 0) { cm.innerHTML = '<div class="empty-msg">// NO DELETED MESSAGES //</div>'; return; }
    msgs.forEach(m => renderBubble(m, cm, true));
    cm.scrollTop = cm.scrollHeight;
}

// -- PERMA DELETE WHOLE CONVERSATION --
function openPermaConvModal(type, id) {
    permaConvTarget = { type, id };
    document.getElementById("perma-conv-modal").style.display = "flex";
}

function confirmPermaConvDelete() {
    closeModal("perma-conv-modal");
    if (!permaConvTarget) return;
    let msgs = getMessages();

    if (permaConvTarget.type === 'group') {
        msgs = msgs.filter(m => m.groupId !== permaConvTarget.id);
        saveMessages(msgs);
        // Remove the group record entirely
        saveGroups(getGroups().filter(g => g.id !== permaConvTarget.id));
    } else {
        const target = permaConvTarget.id.toLowerCase();
        msgs = msgs.filter(m => !(
            (m.from.toLowerCase() === currentUser.toLowerCase() && m.to && m.to.toLowerCase() === target) ||
            (m.to && m.to.toLowerCase() === currentUser.toLowerCase() && m.from.toLowerCase() === target)
        ));
        saveMessages(msgs);
    }

    permaConvTarget = null;
    activeConv = null;
    renderConvList();
    document.getElementById("chat-panel").innerHTML = '<div id="chat-placeholder">// CONVERSATION DELETED FOREVER //</div>';
}

// -- RENDER CHAT --
function renderChat() {
    const panel = document.getElementById("chat-panel");
    let msgs, headerHTML;

    if (activeIsGroup) {
        const groups = getGroups();
        const g = groups.find(gr => gr.id === activeConv);
        if (!g) return;
        msgs = getMessages().filter(m => m.groupId === activeConv && !m.deletedMsg).sort((a,b) => a.timestamp - b.timestamp);
        const isCreator = g.createdBy && g.createdBy.toLowerCase() === currentUser.toLowerCase();
        headerHTML = `
            <div id="chat-header">
                <div id="chat-header-info">
                    <div id="chat-header-name">${g.name.toUpperCase()}</div>
                    <div id="chat-header-members">${g.members.join(", ")}</div>
                </div>
                <button class="hdr-btn hdr-green" onclick="openAddMemberModal()">+ ADD</button>
                ${isCreator
                    ? `<button class="hdr-btn hdr-red" onclick="openConfirmDelete()">üóë DELETE</button>`
                    : `<button class="hdr-btn hdr-red" onclick="openLeaveGroupModal()">üö™ LEAVE</button>`
                }
            </div>`;
    } else {
        const displayName = activeConv.toUpperCase();
        msgs = getMessages().filter(m =>
            !m.deletedMsg && !m.groupId &&
            ((m.from.toLowerCase() === currentUser.toLowerCase() && m.to && m.to.toLowerCase() === activeConv) ||
             (m.to && m.to.toLowerCase() === currentUser.toLowerCase() && m.from.toLowerCase() === activeConv))
        ).sort((a,b) => a.timestamp - b.timestamp);
        headerHTML = `
            <div id="chat-header">
                <div id="chat-header-info">
                    <div id="chat-header-name">${displayName}</div>
                </div>
                <button class="hdr-btn hdr-red" onclick="openConfirmDelete()">üóë DELETE CHAT</button>
            </div>`;
    }

    panel.innerHTML = headerHTML + `
        <div id="chat-messages"></div>
        <div id="chat-input-bar">
            <input id="chat-input" placeholder="Type a message..." maxlength="1000" onkeydown="if(event.key==='Enter') sendChat()"/>
            <button id="chat-send-btn" onclick="sendChat()">‚ñ∂ SEND</button>
        </div>
    `;

    const cm = document.getElementById("chat-messages");
    if (msgs.length === 0) {
        cm.innerHTML = '<div style="text-align:center;font-size:11px;letter-spacing:1px;color:#333;margin-top:20px;">// START OF CONVERSATION //</div>';
    } else {
        msgs.forEach(m => renderBubble(m, cm, false));
    }
    cm.scrollTop = cm.scrollHeight;
    setTimeout(() => { const i = document.getElementById("chat-input"); if(i) i.focus(); }, 50);
}

// -- RENDER BUBBLE --
let hideTimers = {};

function renderBubble(m, container, isDeletedView) {
    const isMe = m.from.toLowerCase() === currentUser.toLowerCase();
    const row = document.createElement("div");
    row.className = "bubble-row " + (isMe ? "me" : "them");
    row.id = "row-" + m.id;

    const reactionHtml = m.reaction ? `<span class="reaction">${m.reaction}</span>` : "";
    const editedHtml = m.edited ? `<span class="edited-tag">edited</span>` : "";

    let actionButtons = "";
    if (isDeletedView) {
        actionButtons = `
            <button class="action-btn" title="Recover" onclick="recoverMsg('${m.id}')">‚ôªÔ∏è</button>
            <button class="action-btn red" title="Permanently Delete" onclick="openPermaMsgModal('${m.id}')">üóë</button>`;
    } else {
        actionButtons = `
            <button class="action-btn" title="Like" onclick="reactMsg('${m.id}','üëç')">üëç</button>
            <button class="action-btn" title="Dislike" onclick="reactMsg('${m.id}','üëé')">üëé</button>
            ${isMe ? `<button class="action-btn" title="Edit" onclick="openEditModal('${m.id}')">‚úèÔ∏è</button>` : ""}
            <button class="action-btn red" title="Delete" onclick="deleteMsg('${m.id}')">üóë</button>`;
    }

    row.innerHTML = `
        <div class="bubble-wrap">
            <div class="bubble ${isMe ? "me" : "them"}">${m.body}</div>
            <div class="bubble-meta"><span>${m.from}</span><span style="opacity:0.5">¬∑</span><span>${formatTime(m.timestamp)}</span>${editedHtml}</div>
            ${reactionHtml}
            <div class="bubble-actions" id="actions-${m.id}">${actionButtons}</div>
        </div>
    `;
    container.appendChild(row);

    const wrap = row.querySelector(".bubble-wrap");
    const actions = row.querySelector(".bubble-actions");
    wrap.addEventListener("mouseenter", () => { clearTimeout(hideTimers[m.id]); actions.classList.add("visible"); });
    wrap.addEventListener("mouseleave", () => { hideTimers[m.id] = setTimeout(() => actions.classList.remove("visible"), 600); });
    actions.addEventListener("mouseenter", () => { clearTimeout(hideTimers[m.id]); });
    actions.addEventListener("mouseleave", () => { hideTimers[m.id] = setTimeout(() => actions.classList.remove("visible"), 600); });
}

// -- MESSAGE ACTIONS --
function reactMsg(id, emoji) {
    const msgs = getMessages();
    const m = msgs.find(m => m.id === id);
    if (!m) return;
    m.reaction = m.reaction === emoji ? null : emoji;
    saveMessages(msgs);
    refreshBubble(id);
}

function openEditModal(id) {
    const msgs = getMessages();
    const m = msgs.find(m => m.id === id);
    if (!m) return;
    editingMsgId = id;
    document.getElementById("edit-input").value = m.body;
    document.getElementById("edit-modal").style.display = "flex";
    setTimeout(() => document.getElementById("edit-input").focus(), 50);
}

function saveEdit() {
    const val = document.getElementById("edit-input").value.trim();
    if (!val) return;
    const msgs = getMessages();
    const m = msgs.find(m => m.id === editingMsgId);
    if (m) { m.body = val; m.edited = true; }
    saveMessages(msgs);
    closeModal("edit-modal");
    refreshBubble(editingMsgId);
    renderConvList();
}

function deleteMsg(id) {
    const msgs = getMessages();
    const m = msgs.find(m => m.id === id);
    if (!m) return;
    m.deletedMsg = true;
    saveMessages(msgs);
    const row = document.getElementById("row-" + id);
    if (row) row.remove();
    renderConvList();
}

function recoverMsg(id) {
    const msgs = getMessages();
    const m = msgs.find(m => m.id === id);
    if (!m) return;
    m.deletedMsg = false;
    saveMessages(msgs);

    // If group message, un-delete the group too so it reappears in GROUP CHATS
    if (m.groupId) {
        const groups = getGroups();
        const g = groups.find(gr => gr.id === m.groupId);
        if (g && g.deleted) { g.deleted = false; saveGroups(groups); }
    }

    const row = document.getElementById("row-" + id);
    if (row) row.remove();
    renderConvList();

    // Check if any deleted msgs remain
    const remaining = m.groupId
        ? getMessages().filter(msg => msg.deletedMsg && msg.groupId === m.groupId)
        : getMessages().filter(msg =>
            msg.deletedMsg &&
            ((msg.from.toLowerCase() === currentUser.toLowerCase() && msg.to && msg.to.toLowerCase() === activeConv) ||
             (msg.to && msg.to.toLowerCase() === currentUser.toLowerCase() && msg.from.toLowerCase() === activeConv))
          );
    if (remaining.length === 0) {
        document.getElementById("chat-panel").innerHTML = '<div id="chat-placeholder">// NO MORE DELETED MESSAGES //</div>';
    }
}

function recoverAllMsgs(username) {
    const msgs = getMessages();
    msgs.forEach(m => {
        if (m.deletedMsg &&
            ((m.from.toLowerCase() === currentUser.toLowerCase() && m.to && m.to.toLowerCase() === username.toLowerCase()) ||
             (m.to && m.to.toLowerCase() === currentUser.toLowerCase() && m.from.toLowerCase() === username.toLowerCase()))) {
            m.deletedMsg = false;
        }
    });
    saveMessages(msgs);
    activeConv = null;
    renderConvList();
    document.getElementById("chat-panel").innerHTML = '<div id="chat-placeholder">// ALL MESSAGES RECOVERED //</div>';
}

function openPermaMsgModal(id) {
    permaMsgId = id;
    document.getElementById("perma-msg-modal").style.display = "flex";
}

function confirmPermaMsgDelete() {
    let msgs = getMessages();
    msgs = msgs.filter(m => m.id !== permaMsgId);
    saveMessages(msgs);
    closeModal("perma-msg-modal");
    const row = document.getElementById("row-" + permaMsgId);
    if (row) row.remove();
    renderConvList();
}

function refreshBubble(id) {
    const msgs = getMessages();
    const m = msgs.find(m => m.id === id);
    if (!m) return;
    const row = document.getElementById("row-" + id);
    if (!row) return;
    const temp = document.createElement("div");
    renderBubble(m, temp, false);
    row.replaceWith(temp.firstChild);
}

// -- SEND --
function sendChat() {
    const input = document.getElementById("chat-input");
    if (!input || !activeConv) return;
    const body = input.value.trim();
    if (!body) return;
    const msgs = getMessages();
    const msg = { id: Date.now().toString(), from: currentUser, body, timestamp: Date.now(), read: false };
    if (activeIsGroup) { msg.groupId = activeConv; } else { msg.to = activeConv; }
    msgs.push(msg);
    saveMessages(msgs);
    input.value = "";
    renderConvList();
    renderChat();
}

// -- DELETE CHAT --
function openConfirmDelete() {
    document.getElementById("confirm-modal").style.display = "flex";
}

function confirmDeleteChat() {
    closeModal("confirm-modal");
    const msgs = getMessages();
    msgs.forEach(m => {
        if (activeIsGroup) {
            if (m.groupId === activeConv) m.deletedMsg = true;
        } else {
            if ((m.from.toLowerCase() === currentUser.toLowerCase() && m.to && m.to.toLowerCase() === activeConv) ||
                (m.to && m.to.toLowerCase() === currentUser.toLowerCase() && m.from.toLowerCase() === activeConv)) {
                m.deletedMsg = true;
            }
        }
    });
    saveMessages(msgs);

    // Mark the group as deleted so it moves from GROUP CHATS ‚Üí DELETED CHATS
    if (activeIsGroup) {
        const groups = getGroups();
        const g = groups.find(gr => gr.id === activeConv);
        if (g) { g.deleted = true; saveGroups(groups); }
    }

    activeConv = null;
    renderConvList();
    document.getElementById("chat-panel").innerHTML = '<div id="chat-placeholder">// SELECT A CONVERSATION //</div>';
}

// -- NEW CHAT --
function openNewChatModal() {
    document.getElementById("new-chat-user").value = "";
    document.getElementById("new-chat-error").innerText = "";
    document.getElementById("new-chat-modal").style.display = "flex";
    setTimeout(() => document.getElementById("new-chat-user").focus(), 50);
}

function startNewChat() {
    const username = document.getElementById("new-chat-user").value.trim();
    const err = document.getElementById("new-chat-error");
    if (!username) { err.innerText = "Please enter a username."; return; }
    if (username.toLowerCase() === currentUser.toLowerCase()) { err.innerText = "You can't message yourself."; return; }
    const approved = JSON.parse(localStorage.getItem("approvedAccounts")) || [];
    if (!approved.some(a => a.username.toLowerCase() === username.toLowerCase())) { err.innerText = "User not found."; return; }
    closeModal("new-chat-modal");
    switchTab("chats");
    activeConv = username.toLowerCase();
    activeIsGroup = false;
    renderConvList();
    renderChat();
}

// -- GROUP CHATS --
function openNewGroupModal() {
    pendingGroupMembers = [];
    document.getElementById("group-name-input").value = "";
    document.getElementById("group-member-input").value = "";
    document.getElementById("new-group-error").innerText = "";
    renderPendingMembers();
    document.getElementById("new-group-modal").style.display = "flex";
    setTimeout(() => document.getElementById("group-name-input").focus(), 50);
}

function addMemberToGroup() {
    const input = document.getElementById("group-member-input");
    const username = input.value.trim();
    const err = document.getElementById("new-group-error");
    if (!username) return;
    if (username.toLowerCase() === currentUser.toLowerCase()) { err.innerText = "You are already in the group."; return; }
    if (pendingGroupMembers.map(x=>x.toLowerCase()).includes(username.toLowerCase())) { err.innerText = "Already added."; return; }
    const approved = JSON.parse(localStorage.getItem("approvedAccounts")) || [];
    if (!approved.some(a => a.username.toLowerCase() === username.toLowerCase())) { err.innerText = "User not found."; return; }
    err.innerText = "";
    pendingGroupMembers.push(username);
    input.value = "";
    renderPendingMembers();
    input.focus();
}

function renderPendingMembers() {
    const list = document.getElementById("group-members-list");
    list.innerHTML = "";
    pendingGroupMembers.forEach((m, i) => {
        const chip = document.createElement("div");
        chip.className = "member-chip";
        chip.innerHTML = `${m} <button onclick="removePendingMember(${i})">‚úï</button>`;
        list.appendChild(chip);
    });
}

function removePendingMember(i) {
    pendingGroupMembers.splice(i, 1);
    renderPendingMembers();
}

function createGroup() {
    const name = document.getElementById("group-name-input").value.trim();
    const err = document.getElementById("new-group-error");
    if (!name) { err.innerText = "Please enter a group name."; return; }
    if (pendingGroupMembers.length === 0) { err.innerText = "Add at least one member."; return; }
    const groups = getGroups();
    const newGroup = {
        id: "g" + Date.now(),
        name: name,
        members: [currentUser, ...pendingGroupMembers],
        createdBy: currentUser,
        created: Date.now(),
        deleted: false
    };
    groups.push(newGroup);
    saveGroups(groups);
    closeModal("new-group-modal");
    switchTab("group");
    activeConv = newGroup.id;
    activeIsGroup = true;
    renderConvList();
    renderChat();
}

function openAddMemberModal() {
    document.getElementById("add-member-input").value = "";
    document.getElementById("add-member-error").innerText = "";
    document.getElementById("add-member-modal").style.display = "flex";
    setTimeout(() => document.getElementById("add-member-input").focus(), 50);
}

function addMemberToExistingGroup() {
    const username = document.getElementById("add-member-input").value.trim();
    const err = document.getElementById("add-member-error");
    if (!username) { err.innerText = "Please enter a username."; return; }
    const groups = getGroups();
    const g = groups.find(gr => gr.id === activeConv);
    if (!g) return;
    if (g.members.map(x=>x.toLowerCase()).includes(username.toLowerCase())) { err.innerText = "Already in group."; return; }
    const approved = JSON.parse(localStorage.getItem("approvedAccounts")) || [];
    if (!approved.some(a => a.username.toLowerCase() === username.toLowerCase())) { err.innerText = "User not found."; return; }
    g.members.push(username);
    saveGroups(groups);
    closeModal("add-member-modal");
    renderConvList();
    renderChat();
}

// -- LEAVE GROUP --
function openLeaveGroupModal() {
    document.getElementById("leave-group-modal").style.display = "flex";
}

function confirmLeaveGroup() {
    closeModal("leave-group-modal");
    const groups = getGroups();
    const g = groups.find(gr => gr.id === activeConv);
    if (!g) return;
    // Remove the current user from the members list
    g.members = g.members.filter(m => m.toLowerCase() !== currentUser.toLowerCase());
    saveGroups(groups);
    activeConv = null;
    activeIsGroup = false;
    switchTab("group");
}

function closeModal(id) { document.getElementById(id).style.display = "none"; }

window.onload = function () {
    const user = localStorage.getItem("loggedInUser");
    if (!user) { window.location.href = "Index.html"; return; }
    const accounts = JSON.parse(localStorage.getItem("approvedAccounts")) || [];
    const account = accounts.find(a => a.username.toLowerCase() === user.toLowerCase());
    if (!account || !Array.isArray(account.access) || !account.access.includes("Messages")) {
        document.getElementById("main").innerHTML = '<div style="flex:1;display:flex;justify-content:center;align-items:center;font-size:11px;letter-spacing:2px;color:#666;">// ACCESS DENIED //</div>';
        return;
    }
    currentUser = user;
    renderConvList();
};
</script>
</body>
</html>
